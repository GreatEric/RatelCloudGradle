import * as tslib_1 from "tslib";
import { Component, Input, Inject, forwardRef, Output, EventEmitter, ViewChild, ElementRef } from '@angular/core';
import { Colors, HightLevelZindex, ToolboxDefaultOptions } from './screenshot.class';
import { DOMProcess } from './screenshot.utils';
import domtoimage from 'dom-to-image';
import * as jq from 'jquery';
var $ = jq;
/**
 * Capture dom setion with indicate element
 */
var ScreenshotComponent = /** @class */ (function () {
    function ScreenshotComponent(colors, hightLevelZindex, defaultOptions, domprocess) {
        var _this = this;
        this.colors = colors;
        this.hightLevelZindex = hightLevelZindex;
        this.defaultOptions = defaultOptions;
        this.domprocess = domprocess;
        this.isOpenChange = new EventEmitter();
        this.api = new EventEmitter();
        this.showToolbox = false;
        this.cancelText = 'Cancel';
        this.downloadText = 'Download';
        this.filename = 'screenshot.png';
        this.toolboxMargin = 5;
        this.calculateToolboxPosition = function (offsetLeft, offsetTop, rect, toolboxWidth, toolboxHeight) {
            var left = offsetLeft + rect.startX + rect.w;
            var top = offsetTop + rect.startY + rect.h;
            if (rect.w >= 0) {
                left -= toolboxWidth;
            }
            if (rect.h >= 0) {
                top += _this.toolboxMargin;
            }
            else {
                top = top - toolboxHeight - _this.toolboxMargin;
            }
            return {
                left: left,
                top: top
            };
        };
        this.cancel = function () {
            _this.showToolbox = false;
            _this.domprocess.clearCanvasRect(_this.interactiveCanvas);
        };
        this.download = function () {
            _this.isOpenChange.emit(false);
            window.setTimeout(function () {
                var elementSelector = _this.getElementSelector();
                var element = elementSelector[0];
                var options = _this.getOptions(element);
                domtoimage
                    .toPng(element, options)
                    .then(_this.domprocess.dataUrlToImage)
                    .then(function (image) {
                    _this.domprocess.remove(image);
                    return _this.domprocess.clipImageToCanvas(image, _this.rect.startX, _this.rect.startY, _this.rect.w, _this.rect.h);
                })
                    .then(function (canvas) { return _this.domprocess.downloadCanvas(canvas, _this.toolboxOptions.filename); })
                    .then(_this.domprocess.remove)
                    .catch(function (error) { return console.error(error); });
            });
        };
        this.downloadFull = function () {
            _this.isOpenChange.emit(false);
            window.setTimeout(function () {
                var elementSelector = _this.getElementSelector();
                var element = elementSelector[0];
                var options = _this.getOptions(element);
                domtoimage
                    .toPng(element, options)
                    .then(function (imageUrl) { return _this.domprocess.downloadByUrl(imageUrl, _this.toolboxOptions.filename); })
                    .catch(function (error) { return console.error(error); });
            });
        };
        this.findMaxZindex = function () {
            var zMax = 0;
            $('body *').each(function () {
                var zIndexStr = $(this).css('zIndex');
                var zIndex = parseInt(zIndexStr, 10);
                if (zIndex && zIndex > zMax) {
                    zMax = zIndex;
                }
            });
            return zMax;
        };
        this.getElementSelector = function () {
            return _this.target
                ? $(_this.target)
                : $(_this.container.nativeElement).filter(function (index, element) {
                    var elementName = element.tagName.toLowerCase();
                    return elementName !== 'screenshot-toolbox';
                });
        };
        this.getOptions = function (element) {
            var boudingClientRect = element.getBoundingClientRect();
            var options = {
                width: boudingClientRect.width,
                height: boudingClientRect.height
            };
            if (_this.domprocess.isTransparent(element)) {
                var parentBackgroundColor = _this.domprocess.getStyle(element, 'backgroundColor');
                options = Object.assign({}, options, { bgcolor: parentBackgroundColor });
            }
            return options;
        };
        this.setHightLevelZindex = function () {
            var maxZindex = _this.findMaxZindex();
            _this.hightLevelZindex.second = maxZindex + 1;
            _this.hightLevelZindex.top = _this.hightLevelZindex.second + 1;
        };
        this.toPng = function (callback) {
            return new Promise(function (resolve, reject) {
                _this.isOpenChange.emit(false);
                window.setTimeout(function () {
                    var elementSelector = _this.getElementSelector();
                    var element = elementSelector[0];
                    var options = _this.getOptions(element);
                    return domtoimage
                        .toPng(element, options)
                        .then(_this.domprocess.dataUrlToImage)
                        .then(function (image) {
                        _this.domprocess.remove(image);
                        return _this.domprocess.clipImageToCanvas(image, _this.rect.startX, _this.rect.startY, _this.rect.w, _this.rect.h);
                    })
                        .then(function (canvas) {
                        var url = canvas.toDataURL('image/png');
                        if (callback) {
                            callback(url);
                        }
                        resolve(url);
                    })
                        .catch(function (error) {
                        console.error(error);
                        reject(error);
                    });
                });
            });
        };
        this.canvasMousedownListener = function () {
            _this.showToolbox = false;
        };
        this.canvasMouseupListener = function (canvas, rect) {
            if (rect.w !== 0 && rect.h !== 0) {
                // this.showToolbox = false;
                _this.rect = rect;
                var toolbox = $(_this.container.nativeElement).find('ng2-screenshot-toolbox');
                console.log(toolbox.outerWidth());
                // console.log(toolbox.width())
                // // const toolbox = $('ng2-screenshot-toolbox');
                var toolboxElement = toolbox.get(0);
                console.log(toolboxElement.clientWidth);
                console.log(_this.hightLevelZindex);
                /**
                 * toolbox position setting
                 * because read elememt's width sould indicated postion method, so we set position method first then move location with dom.
                 */
                _this.domprocess
                    .setToolboxStackStyle(toolboxElement, _this.hightLevelZindex.top.toString())
                    // .then(this.domprocess.appendToBody)
                    .then(function (element) {
                    var position = _this.calculateToolboxPosition(canvas.offsetLeft, canvas.offsetTop, rect, element.offsetWidth, element.offsetHeight);
                    return _this.domprocess.setToolboxPositionStyle(element, position.left, position.top);
                })
                    .then(function (element) {
                    _this.showToolbox = true;
                });
            }
        };
        this.canvasContextmenuListener = function () {
            _this.isOpenChange.emit(false);
        };
        this.closeScreenshot = function () {
            _this.domprocess.remove(_this.interactiveCanvas);
            _this.showToolbox = false;
        };
        this.resizeCanvas = function () {
            if (!_this.interactiveCanvas) {
                return;
            }
            var elementSelector = _this.getElementSelector();
            var boudingClientRect = elementSelector[0].getBoundingClientRect();
            var width = boudingClientRect.width;
            var height = boudingClientRect.height;
            var offset = elementSelector.offset();
            var left = offset.left;
            var top = offset.top;
            _this.interactiveCanvas.width = width;
            _this.interactiveCanvas.height = height;
            _this.domprocess
                .setCanvasStyle(_this.interactiveCanvas, left, top, _this.colors.gray, _this.hightLevelZindex.second.toString())
                .then(function () { return _this.showToolbox = false; });
        };
    }
    ScreenshotComponent.prototype.ngOnInit = function () {
        var _this = this;
        if (!this.toolboxOptions) {
            this.toolboxOptions = {
                filename: this.defaultOptions.filename,
                cancelText: this.defaultOptions.cancelText,
                downloadText: this.defaultOptions.downloadText
            };
        }
        this.api.emit({
            cancel: this.cancel,
            download: this.download,
            downloadFull: this.downloadFull,
            toPng: this.toPng
        });
        window.onresize = function () {
            _this.resizeCanvas();
        };
    };
    ScreenshotComponent.prototype.ngOnChanges = function (item) {
        var isOpen = item.isOpen, toolboxOptions = item.toolboxOptions;
        switch (isOpen.currentValue) {
            case true:
                this.openScreenshot();
                break;
            case false:
                this.closeScreenshot();
                break;
            default:
                this.closeScreenshot();
                break;
        }
        if (toolboxOptions) {
            this.cancelText = toolboxOptions.cancelText ? toolboxOptions.cancelText : this.cancelText;
            this.downloadText = toolboxOptions.downloadText ? toolboxOptions.downloadText : this.downloadText;
            this.filename = toolboxOptions.filename ? toolboxOptions.filename : this.filename;
        }
    };
    ScreenshotComponent.prototype.openScreenshot = function () {
        var _this = this;
        var elementSelector = this.getElementSelector();
        var boudingClientRect = elementSelector[0].getBoundingClientRect();
        var width = boudingClientRect.width;
        var height = boudingClientRect.height;
        var offset = elementSelector.offset();
        var left = offset.left;
        var top = offset.top;
        this.setHightLevelZindex();
        this.domprocess
            .createCanvas(width, height)
            .then(function (canvas) {
            return _this.domprocess.setCanvasStyle(canvas, left, top, _this.colors.gray, _this.hightLevelZindex.second.toString());
        })
            .then(this.domprocess.appendToBody)
            .then(function (canvas) {
            return _this.domprocess.listenInteractiveCanvas(canvas, _this.colors.lightGray, _this.canvasMouseupListener, _this.canvasMousedownListener, _this.canvasContextmenuListener);
        })
            .then(function (canvas) { return (_this.interactiveCanvas = canvas); });
    };
    ScreenshotComponent.ctorParameters = function () { return [
        { type: Colors, decorators: [{ type: Inject, args: [forwardRef(function () { return Colors; }),] }] },
        { type: HightLevelZindex, decorators: [{ type: Inject, args: [forwardRef(function () { return HightLevelZindex; }),] }] },
        { type: ToolboxDefaultOptions, decorators: [{ type: Inject, args: [forwardRef(function () { return ToolboxDefaultOptions; }),] }] },
        { type: DOMProcess, decorators: [{ type: Inject, args: [forwardRef(function () { return DOMProcess; }),] }] }
    ]; };
    tslib_1.__decorate([
        ViewChild('container', { static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], ScreenshotComponent.prototype, "container", void 0);
    tslib_1.__decorate([
        Input('target'),
        tslib_1.__metadata("design:type", String)
    ], ScreenshotComponent.prototype, "target", void 0);
    tslib_1.__decorate([
        Input('isOpen'),
        tslib_1.__metadata("design:type", Boolean)
    ], ScreenshotComponent.prototype, "isOpen", void 0);
    tslib_1.__decorate([
        Input('toolboxOptions'),
        tslib_1.__metadata("design:type", Object)
    ], ScreenshotComponent.prototype, "toolboxOptions", void 0);
    tslib_1.__decorate([
        Output('isOpenChange'),
        tslib_1.__metadata("design:type", Object)
    ], ScreenshotComponent.prototype, "isOpenChange", void 0);
    tslib_1.__decorate([
        Output('apiInitialized'),
        tslib_1.__metadata("design:type", Object)
    ], ScreenshotComponent.prototype, "api", void 0);
    ScreenshotComponent = tslib_1.__decorate([
        Component({
            selector: 'ng2-screenshot',
            template: '<div #container><ng-content></ng-content></div>'
        }),
        tslib_1.__param(0, Inject(forwardRef(function () { return Colors; }))),
        tslib_1.__param(1, Inject(forwardRef(function () { return HightLevelZindex; }))),
        tslib_1.__param(2, Inject(forwardRef(function () { return ToolboxDefaultOptions; }))),
        tslib_1.__param(3, Inject(forwardRef(function () { return DOMProcess; }))),
        tslib_1.__metadata("design:paramtypes", [Colors,
            HightLevelZindex,
            ToolboxDefaultOptions,
            DOMProcess])
    ], ScreenshotComponent);
    return ScreenshotComponent;
}());
export { ScreenshotComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyZWVuc2hvdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZzItc2NyZWVuc2hvdC8iLCJzb3VyY2VzIjpbImxpYi9zY3JlZW5zaG90LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBcUIsTUFBTSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXJJLE9BQU8sRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxVQUFVLE1BQU0sY0FBYyxDQUFDO0FBQ3RDLE9BQU8sS0FBSyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzdCLElBQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNiOztHQUVHO0FBS0g7SUFjSSw2QkFDOEMsTUFBYyxFQUNKLGdCQUFrQyxFQUM3QixjQUFxQyxFQUNoRCxVQUFzQjtRQUp4RSxpQkFLSztRQUp5QyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ0oscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUM3QixtQkFBYyxHQUFkLGNBQWMsQ0FBdUI7UUFDaEQsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQWJoRCxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDaEMsUUFBRyxHQUFHLElBQUksWUFBWSxFQUFvQixDQUFDO1FBQzlELGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ25CLGVBQVUsR0FBRyxRQUFRLENBQUM7UUFDdEIsaUJBQVksR0FBRyxVQUFVLENBQUM7UUFDMUIsYUFBUSxHQUFHLGdCQUFnQixDQUFDO1FBQzVCLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBZ0RsQiw2QkFBd0IsR0FBRyxVQUMvQixVQUFrQixF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QUFDOzt1REFBaUI7SUFDUjtRQUF4QixLQUFLLENBQUMsZ0JBQWdCLENBQUM7OytEQUFnQztJQUNoQztRQUF2QixNQUFNLENBQUMsY0FBYyxDQUFDOzs2REFBbUM7SUFDaEM7UUFBekIsTUFBTSxDQUFDLGdCQUFnQixDQUFDOztvREFBNEM7SUFONUQsbUJBQW1CO1FBSi9CLFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxnQkFBZ0I7WUFDMUIsUUFBUSxFQUFFLGlEQUFpRDtTQUM5RCxDQUFDO1FBZ0JPLG1CQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsY0FBTSxPQUFBLE1BQU0sRUFBTixDQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ2hDLG1CQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsY0FBTSxPQUFBLGdCQUFnQixFQUFoQixDQUFnQixDQUFDLENBQUMsQ0FBQTtRQUMxQyxtQkFBQSxNQUFNLENBQUMsVUFBVSxDQUFDLGNBQU0sT0FBQSxxQkFBcUIsRUFBckIsQ0FBcUIsQ0FBQyxDQUFDLENBQUE7UUFDL0MsbUJBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxjQUFNLE9BQUEsVUFBVSxFQUFWLENBQVUsQ0FBQyxDQUFDLENBQUE7aURBSGEsTUFBTTtZQUNjLGdCQUFnQjtZQUNiLHFCQUFxQjtZQUNwQyxVQUFVO09BbEIvRCxtQkFBbUIsQ0FnVC9CO0lBQUQsMEJBQUM7Q0FBQSxBQWhURCxJQWdUQztTQWhUWSxtQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBJbmplY3QsIGZvcndhcmRSZWYsIE9uSW5pdCwgT25DaGFuZ2VzLCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgVmlld0NoaWxkLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRvb2xib3hPcHRpb25zLCBOZzJTY3JlZW5zaG90QVBJLCBSZWN0LCBUb29sYm94UG9zaXRpb24gfSBmcm9tICcuL3NjcmVlbnNob3QuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgQ29sb3JzLCBIaWdodExldmVsWmluZGV4LCBUb29sYm94RGVmYXVsdE9wdGlvbnMgfSBmcm9tICcuL3NjcmVlbnNob3QuY2xhc3MnO1xyXG5pbXBvcnQgeyBET01Qcm9jZXNzIH0gZnJvbSAnLi9zY3JlZW5zaG90LnV0aWxzJztcclxuaW1wb3J0IGRvbXRvaW1hZ2UgZnJvbSAnZG9tLXRvLWltYWdlJztcclxuaW1wb3J0ICogYXMganEgZnJvbSAnanF1ZXJ5JztcclxuY29uc3QgJCA9IGpxO1xyXG4vKipcclxuICogQ2FwdHVyZSBkb20gc2V0aW9uIHdpdGggaW5kaWNhdGUgZWxlbWVudFxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ25nMi1zY3JlZW5zaG90JyxcclxuICAgIHRlbXBsYXRlOiAnPGRpdiAjY29udGFpbmVyPjxuZy1jb250ZW50PjwvbmctY29udGVudD48L2Rpdj4nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTY3JlZW5zaG90Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xyXG4gICAgQFZpZXdDaGlsZCgnY29udGFpbmVyJywgeyBzdGF0aWM6IGZhbHNlIH0pIGNvbnRhaW5lcjogRWxlbWVudFJlZjtcclxuICAgIEBJbnB1dCgndGFyZ2V0JykgdGFyZ2V0OiBzdHJpbmc7XHJcbiAgICBASW5wdXQoJ2lzT3BlbicpIGlzT3BlbjogYm9vbGVhbjtcclxuICAgIEBJbnB1dCgndG9vbGJveE9wdGlvbnMnKSB0b29sYm94T3B0aW9uczogVG9vbGJveE9wdGlvbnM7XHJcbiAgICBAT3V0cHV0KCdpc09wZW5DaGFuZ2UnKSBpc09wZW5DaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICBAT3V0cHV0KCdhcGlJbml0aWFsaXplZCcpIGFwaSA9IG5ldyBFdmVudEVtaXR0ZXI8TmcyU2NyZWVuc2hvdEFQST4oKTtcclxuICAgIHB1YmxpYyBzaG93VG9vbGJveCA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBjYW5jZWxUZXh0ID0gJ0NhbmNlbCc7XHJcbiAgICBwcml2YXRlIGRvd25sb2FkVGV4dCA9ICdEb3dubG9hZCc7XHJcbiAgICBwcml2YXRlIGZpbGVuYW1lID0gJ3NjcmVlbnNob3QucG5nJztcclxuICAgIHByaXZhdGUgdG9vbGJveE1hcmdpbiA9IDU7XHJcbiAgICBwcml2YXRlIGludGVyYWN0aXZlQ2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudDtcclxuICAgIHByaXZhdGUgcmVjdDogUmVjdDtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBDb2xvcnMpKSBwcml2YXRlIGNvbG9yczogQ29sb3JzLFxyXG4gICAgICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBIaWdodExldmVsWmluZGV4KSkgcHJpdmF0ZSBoaWdodExldmVsWmluZGV4OiBIaWdodExldmVsWmluZGV4LFxyXG4gICAgICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBUb29sYm94RGVmYXVsdE9wdGlvbnMpKSBwcml2YXRlIGRlZmF1bHRPcHRpb25zOiBUb29sYm94RGVmYXVsdE9wdGlvbnMsXHJcbiAgICAgICAgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IERPTVByb2Nlc3MpKSBwcml2YXRlIGRvbXByb2Nlc3M6IERPTVByb2Nlc3MsXHJcbiAgICApIHsgfVxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRvb2xib3hPcHRpb25zKSB7XHJcbiAgICAgICAgICAgIHRoaXMudG9vbGJveE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICBmaWxlbmFtZTogdGhpcy5kZWZhdWx0T3B0aW9ucy5maWxlbmFtZSxcclxuICAgICAgICAgICAgICAgIGNhbmNlbFRleHQ6IHRoaXMuZGVmYXVsdE9wdGlvbnMuY2FuY2VsVGV4dCxcclxuICAgICAgICAgICAgICAgIGRvd25sb2FkVGV4dDogdGhpcy5kZWZhdWx0T3B0aW9ucy5kb3dubG9hZFRleHRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5hcGkuZW1pdCh7XHJcbiAgICAgICAgICAgIGNhbmNlbDogdGhpcy5jYW5jZWwsXHJcbiAgICAgICAgICAgIGRvd25sb2FkOiB0aGlzLmRvd25sb2FkLFxyXG4gICAgICAgICAgICBkb3dubG9hZEZ1bGw6IHRoaXMuZG93bmxvYWRGdWxsLFxyXG4gICAgICAgICAgICB0b1BuZzogdGhpcy50b1BuZ1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHdpbmRvdy5vbnJlc2l6ZSA9ICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZXNpemVDYW52YXMoKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGl0ZW06IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHsgaXNPcGVuLCB0b29sYm94T3B0aW9ucyB9ID0gaXRlbTtcclxuICAgICAgICBzd2l0Y2ggKGlzT3Blbi5jdXJyZW50VmFsdWUpIHtcclxuICAgICAgICAgICAgY2FzZSB0cnVlOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuU2NyZWVuc2hvdCgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZmFsc2U6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlU2NyZWVuc2hvdCgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlU2NyZWVuc2hvdCgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0b29sYm94T3B0aW9ucykge1xyXG4gICAgICAgICAgICB0aGlzLmNhbmNlbFRleHQgPSB0b29sYm94T3B0aW9ucy5jYW5jZWxUZXh0ID8gdG9vbGJveE9wdGlvbnMuY2FuY2VsVGV4dCA6IHRoaXMuY2FuY2VsVGV4dDtcclxuICAgICAgICAgICAgdGhpcy5kb3dubG9hZFRleHQgPSB0b29sYm94T3B0aW9ucy5kb3dubG9hZFRleHQgPyB0b29sYm94T3B0aW9ucy5kb3dubG9hZFRleHQgOiB0aGlzLmRvd25sb2FkVGV4dDtcclxuICAgICAgICAgICAgdGhpcy5maWxlbmFtZSA9IHRvb2xib3hPcHRpb25zLmZpbGVuYW1lID8gdG9vbGJveE9wdGlvbnMuZmlsZW5hbWUgOiB0aGlzLmZpbGVuYW1lO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhbGN1bGF0ZVRvb2xib3hQb3NpdGlvbiA9IChcclxuICAgICAgICBvZmZzZXRMZWZ0OiBudW1iZXIsXHJcbiAgICAgICAgb2Zmc2V0VG9wOiBudW1iZXIsXHJcbiAgICAgICAgcmVjdDogUmVjdCxcclxuICAgICAgICB0b29sYm94V2lkdGg6IG51bWJlcixcclxuICAgICAgICB0b29sYm94SGVpZ2h0OiBudW1iZXJcclxuICAgICk6IFRvb2xib3hQb3NpdGlvbiA9PiB7XHJcbiAgICAgICAgbGV0IGxlZnQgPSBvZmZzZXRMZWZ0ICsgcmVjdC5zdGFydFggKyByZWN0Lnc7XHJcbiAgICAgICAgbGV0IHRvcCA9IG9mZnNldFRvcCArIHJlY3Quc3RhcnRZICsgcmVjdC5oO1xyXG4gICAgICAgIGlmIChyZWN0LncgPj0gMCkge1xyXG4gICAgICAgICAgICBsZWZ0IC09IHRvb2xib3hXaWR0aDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHJlY3QuaCA+PSAwKSB7XHJcbiAgICAgICAgICAgIHRvcCArPSB0aGlzLnRvb2xib3hNYXJnaW47XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdG9wID0gdG9wIC0gdG9vbGJveEhlaWdodCAtIHRoaXMudG9vbGJveE1hcmdpbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbGVmdCxcclxuICAgICAgICAgICAgdG9wXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2FuY2VsID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2hvd1Rvb2xib3ggPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmRvbXByb2Nlc3MuY2xlYXJDYW52YXNSZWN0KHRoaXMuaW50ZXJhY3RpdmVDYW52YXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkb3dubG9hZCA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmlzT3BlbkNoYW5nZS5lbWl0KGZhbHNlKTtcclxuICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRTZWxlY3RvciA9IHRoaXMuZ2V0RWxlbWVudFNlbGVjdG9yKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBlbGVtZW50U2VsZWN0b3JbMF07XHJcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldE9wdGlvbnMoZWxlbWVudCk7XHJcbiAgICAgICAgICAgIGRvbXRvaW1hZ2VcclxuICAgICAgICAgICAgICAgIC50b1BuZyhlbGVtZW50LCBvcHRpb25zKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4odGhpcy5kb21wcm9jZXNzLmRhdGFVcmxUb0ltYWdlKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb21wcm9jZXNzLnJlbW92ZShpbWFnZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tcHJvY2Vzcy5jbGlwSW1hZ2VUb0NhbnZhcyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVjdC5zdGFydFgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVjdC5zdGFydFksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVjdC53LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY3QuaFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpID0+IHRoaXMuZG9tcHJvY2Vzcy5kb3dubG9hZENhbnZhcyhjYW52YXMsIHRoaXMudG9vbGJveE9wdGlvbnMuZmlsZW5hbWUpKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4odGhpcy5kb21wcm9jZXNzLnJlbW92ZSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEVycm9yKSA9PiBjb25zb2xlLmVycm9yKGVycm9yKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkb3dubG9hZEZ1bGwgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pc09wZW5DaGFuZ2UuZW1pdChmYWxzZSk7XHJcbiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBlbGVtZW50U2VsZWN0b3IgPSB0aGlzLmdldEVsZW1lbnRTZWxlY3RvcigpO1xyXG4gICAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudFNlbGVjdG9yWzBdO1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRPcHRpb25zKGVsZW1lbnQpO1xyXG4gICAgICAgICAgICBkb210b2ltYWdlXHJcbiAgICAgICAgICAgICAgICAudG9QbmcoZWxlbWVudCwgb3B0aW9ucylcclxuICAgICAgICAgICAgICAgIC50aGVuKChpbWFnZVVybDogc3RyaW5nKSA9PiB0aGlzLmRvbXByb2Nlc3MuZG93bmxvYWRCeVVybChpbWFnZVVybCwgdGhpcy50b29sYm94T3B0aW9ucy5maWxlbmFtZSkpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yOiBFcnJvcikgPT4gY29uc29sZS5lcnJvcihlcnJvcikpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZmluZE1heFppbmRleCA9ICgpOiBudW1iZXIgPT4ge1xyXG4gICAgICAgIGxldCB6TWF4ID0gMDtcclxuICAgICAgICAkKCdib2R5IConKS5lYWNoKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBjb25zdCB6SW5kZXhTdHI6IHN0cmluZyA9ICQodGhpcykuY3NzKCd6SW5kZXgnKTtcclxuICAgICAgICAgICAgY29uc3QgekluZGV4OiBudW1iZXIgPSBwYXJzZUludCh6SW5kZXhTdHIsIDEwKTtcclxuICAgICAgICAgICAgaWYgKHpJbmRleCAmJiB6SW5kZXggPiB6TWF4KSB7XHJcbiAgICAgICAgICAgICAgICB6TWF4ID0gekluZGV4O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHpNYXg7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRFbGVtZW50U2VsZWN0b3IgPSAoKTogSlF1ZXJ5PEhUTUxFbGVtZW50PiA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudGFyZ2V0XHJcbiAgICAgICAgICAgID8gJCh0aGlzLnRhcmdldClcclxuICAgICAgICAgICAgOiAkKHRoaXMuY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQpLmZpbHRlcigoaW5kZXg6IG51bWJlciwgZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnROYW1lID0gZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudE5hbWUgIT09ICdzY3JlZW5zaG90LXRvb2xib3gnO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldE9wdGlvbnMgPSAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHtcclxuICAgICAgICBjb25zdCBib3VkaW5nQ2xpZW50UmVjdCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIHdpZHRoOiBib3VkaW5nQ2xpZW50UmVjdC53aWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OiBib3VkaW5nQ2xpZW50UmVjdC5oZWlnaHRcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmICh0aGlzLmRvbXByb2Nlc3MuaXNUcmFuc3BhcmVudChlbGVtZW50KSkge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnRCYWNrZ3JvdW5kQ29sb3IgPSB0aGlzLmRvbXByb2Nlc3MuZ2V0U3R5bGUoZWxlbWVudCwgJ2JhY2tncm91bmRDb2xvcicpO1xyXG4gICAgICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucywgeyBiZ2NvbG9yOiBwYXJlbnRCYWNrZ3JvdW5kQ29sb3IgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBvcHRpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0SGlnaHRMZXZlbFppbmRleCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBtYXhaaW5kZXggPSB0aGlzLmZpbmRNYXhaaW5kZXgoKTtcclxuICAgICAgICB0aGlzLmhpZ2h0TGV2ZWxaaW5kZXguc2Vjb25kID0gbWF4WmluZGV4ICsgMTtcclxuICAgICAgICB0aGlzLmhpZ2h0TGV2ZWxaaW5kZXgudG9wID0gdGhpcy5oaWdodExldmVsWmluZGV4LnNlY29uZCArIDE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0b1BuZyA9IChjYWxsYmFjazogKHVybDogc3RyaW5nKSA9PiB2b2lkKTogUHJvbWlzZTxzdHJpbmc+ID0+XHJcbiAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmlzT3BlbkNoYW5nZS5lbWl0KGZhbHNlKTtcclxuICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudFNlbGVjdG9yID0gdGhpcy5nZXRFbGVtZW50U2VsZWN0b3IoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBlbGVtZW50U2VsZWN0b3JbMF07XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRPcHRpb25zKGVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbXRvaW1hZ2VcclxuICAgICAgICAgICAgICAgICAgICAudG9QbmcoZWxlbWVudCwgb3B0aW9ucylcclxuICAgICAgICAgICAgICAgICAgICAudGhlbih0aGlzLmRvbXByb2Nlc3MuZGF0YVVybFRvSW1hZ2UpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZG9tcHJvY2Vzcy5yZW1vdmUoaW1hZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21wcm9jZXNzLmNsaXBJbWFnZVRvQ2FudmFzKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY3Quc3RhcnRYLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWN0LnN0YXJ0WSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVjdC53LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWN0LmhcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IGNhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHVybCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh1cmwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogRXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgcHVibGljIGNhbnZhc01vdXNlZG93bkxpc3RlbmVyID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2hvd1Rvb2xib3ggPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2FudmFzTW91c2V1cExpc3RlbmVyID0gKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsIHJlY3Q6IFJlY3QpID0+IHtcclxuICAgICAgICBpZiAocmVjdC53ICE9PSAwICYmIHJlY3QuaCAhPT0gMCkge1xyXG4gICAgICAgICAgICAvLyB0aGlzLnNob3dUb29sYm94ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMucmVjdCA9IHJlY3Q7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvb2xib3ggPSAkKHRoaXMuY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQpLmZpbmQoJ25nMi1zY3JlZW5zaG90LXRvb2xib3gnKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2codG9vbGJveC5vdXRlcldpZHRoKCkpO1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyh0b29sYm94LndpZHRoKCkpXHJcbiAgICAgICAgICAgIC8vIC8vIGNvbnN0IHRvb2xib3ggPSAkKCduZzItc2NyZWVuc2hvdC10b29sYm94Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvb2xib3hFbGVtZW50ID0gdG9vbGJveC5nZXQoMCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyh0b29sYm94RWxlbWVudC5jbGllbnRXaWR0aCkgXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuaGlnaHRMZXZlbFppbmRleClcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIHRvb2xib3ggcG9zaXRpb24gc2V0dGluZ1xyXG4gICAgICAgICAgICAgKiBiZWNhdXNlIHJlYWQgZWxlbWVtdCdzIHdpZHRoIHNvdWxkIGluZGljYXRlZCBwb3N0aW9uIG1ldGhvZCwgc28gd2Ugc2V0IHBvc2l0aW9uIG1ldGhvZCBmaXJzdCB0aGVuIG1vdmUgbG9jYXRpb24gd2l0aCBkb20uXHJcbiAgICAgICAgICAgICAqL1xyXG4gICAgICAgICAgICB0aGlzLmRvbXByb2Nlc3NcclxuICAgICAgICAgICAgICAgIC5zZXRUb29sYm94U3RhY2tTdHlsZSh0b29sYm94RWxlbWVudCwgdGhpcy5oaWdodExldmVsWmluZGV4LnRvcC50b1N0cmluZygpKVxyXG4gICAgICAgICAgICAgICAgLy8gLnRoZW4odGhpcy5kb21wcm9jZXNzLmFwcGVuZFRvQm9keSlcclxuICAgICAgICAgICAgICAgIC50aGVuKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5jYWxjdWxhdGVUb29sYm94UG9zaXRpb24oXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbnZhcy5vZmZzZXRMZWZ0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW52YXMub2Zmc2V0VG9wLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWN0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9mZnNldFdpZHRoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9mZnNldEhlaWdodFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tcHJvY2Vzcy5zZXRUb29sYm94UG9zaXRpb25TdHlsZShlbGVtZW50LCBwb3NpdGlvbi5sZWZ0LCBwb3NpdGlvbi50b3ApO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1Rvb2xib3ggPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjYW52YXNDb250ZXh0bWVudUxpc3RlbmVyID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuaXNPcGVuQ2hhbmdlLmVtaXQoZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xvc2VTY3JlZW5zaG90ID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZG9tcHJvY2Vzcy5yZW1vdmUodGhpcy5pbnRlcmFjdGl2ZUNhbnZhcyk7XHJcbiAgICAgICAgdGhpcy5zaG93VG9vbGJveCA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb3BlblNjcmVlbnNob3QoKSB7XHJcbiAgICAgICAgY29uc3QgZWxlbWVudFNlbGVjdG9yID0gdGhpcy5nZXRFbGVtZW50U2VsZWN0b3IoKTtcclxuICAgICAgICBjb25zdCBib3VkaW5nQ2xpZW50UmVjdCA9IGVsZW1lbnRTZWxlY3RvclswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IGJvdWRpbmdDbGllbnRSZWN0LndpZHRoO1xyXG4gICAgICAgIGNvbnN0IGhlaWdodCA9IGJvdWRpbmdDbGllbnRSZWN0LmhlaWdodDtcclxuICAgICAgICBjb25zdCBvZmZzZXQgPSBlbGVtZW50U2VsZWN0b3Iub2Zmc2V0KCk7XHJcbiAgICAgICAgY29uc3QgbGVmdCA9IG9mZnNldC5sZWZ0O1xyXG4gICAgICAgIGNvbnN0IHRvcCA9IG9mZnNldC50b3A7XHJcbiAgICAgICAgdGhpcy5zZXRIaWdodExldmVsWmluZGV4KCk7XHJcblxyXG4gICAgICAgIHRoaXMuZG9tcHJvY2Vzc1xyXG4gICAgICAgICAgICAuY3JlYXRlQ2FudmFzKHdpZHRoLCBoZWlnaHQpXHJcbiAgICAgICAgICAgIC50aGVuKGNhbnZhcyA9PlxyXG4gICAgICAgICAgICAgICAgdGhpcy5kb21wcm9jZXNzLnNldENhbnZhc1N0eWxlKFxyXG4gICAgICAgICAgICAgICAgICAgIGNhbnZhcyxcclxuICAgICAgICAgICAgICAgICAgICBsZWZ0LFxyXG4gICAgICAgICAgICAgICAgICAgIHRvcCxcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9ycy5ncmF5LFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGlnaHRMZXZlbFppbmRleC5zZWNvbmQudG9TdHJpbmcoKVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC50aGVuKHRoaXMuZG9tcHJvY2Vzcy5hcHBlbmRUb0JvZHkpXHJcbiAgICAgICAgICAgIC50aGVuKGNhbnZhcyA9PlxyXG4gICAgICAgICAgICAgICAgdGhpcy5kb21wcm9jZXNzLmxpc3RlbkludGVyYWN0aXZlQ2FudmFzKFxyXG4gICAgICAgICAgICAgICAgICAgIGNhbnZhcyxcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9ycy5saWdodEdyYXksXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW52YXNNb3VzZXVwTGlzdGVuZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW52YXNNb3VzZWRvd25MaXN0ZW5lcixcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbnZhc0NvbnRleHRtZW51TGlzdGVuZXJcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAudGhlbihjYW52YXMgPT4gKHRoaXMuaW50ZXJhY3RpdmVDYW52YXMgPSBjYW52YXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2l6ZUNhbnZhcyA9ICgpID0+IHtcclxuICAgICAgICBpZiAoIXRoaXMuaW50ZXJhY3RpdmVDYW52YXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBlbGVtZW50U2VsZWN0b3IgPSB0aGlzLmdldEVsZW1lbnRTZWxlY3RvcigpO1xyXG4gICAgICAgIGNvbnN0IGJvdWRpbmdDbGllbnRSZWN0ID0gZWxlbWVudFNlbGVjdG9yWzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0IHdpZHRoID0gYm91ZGluZ0NsaWVudFJlY3Qud2lkdGg7XHJcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYm91ZGluZ0NsaWVudFJlY3QuaGVpZ2h0O1xyXG4gICAgICAgIGNvbnN0IG9mZnNldCA9IGVsZW1lbnRTZWxlY3Rvci5vZmZzZXQoKTtcclxuICAgICAgICBjb25zdCBsZWZ0ID0gb2Zmc2V0LmxlZnQ7XHJcbiAgICAgICAgY29uc3QgdG9wID0gb2Zmc2V0LnRvcDtcclxuICAgICAgICB0aGlzLmludGVyYWN0aXZlQ2FudmFzLndpZHRoID0gd2lkdGg7XHJcbiAgICAgICAgdGhpcy5pbnRlcmFjdGl2ZUNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XHJcbiAgICAgICAgdGhpcy5kb21wcm9jZXNzXHJcbiAgICAgICAgICAgIC5zZXRDYW52YXNTdHlsZShcclxuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJhY3RpdmVDYW52YXMsXHJcbiAgICAgICAgICAgICAgICBsZWZ0LFxyXG4gICAgICAgICAgICAgICAgdG9wLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMuZ3JheSxcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlnaHRMZXZlbFppbmRleC5zZWNvbmQudG9TdHJpbmcoKVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuc2hvd1Rvb2xib3ggPSBmYWxzZSk7XHJcbiAgICB9XHJcbn1cclxuIl19