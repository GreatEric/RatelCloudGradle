import * as tslib_1 from "tslib";
import { Component, Input, Inject, forwardRef, Output, EventEmitter, ViewChild, ElementRef } from '@angular/core';
import { Colors, HightLevelZindex, ToolboxDefaultOptions } from './screenshot.class';
import { DOMProcess } from './screenshot.utils';
import domtoimage from 'dom-to-image';
import * as jq from 'jquery';
const $ = jq;
/**
 * Capture dom setion with indicate element
 */
let ScreenshotComponent = class ScreenshotComponent {
    constructor(colors, hightLevelZindex, defaultOptions, domprocess) {
        this.colors = colors;
        this.hightLevelZindex = hightLevelZindex;
        this.defaultOptions = defaultOptions;
        this.domprocess = domprocess;
        this.isOpenChange = new EventEmitter();
        this.api = new EventEmitter();
        this.showToolbox = false;
        this.cancelText = 'Cancel';
        this.downloadText = 'Download';
        this.filename = 'screenshot.png';
        this.toolboxMargin = 5;
        this.calculateToolboxPosition = (offsetLeft, offsetTop, rect, toolboxWidth, toolboxHeight) => {
            let left = offsetLeft + rect.startX + rect.w;
            let top = offsetTop + rect.startY + rect.h;
            if (rect.w >= 0) {
                left -= toolboxWidth;
            }
            if (rect.h >= 0) {
                top += this.toolboxMargin;
            }
            else {
                top = top - toolboxHeight - this.toolboxMargin;
            }
            return {
                left,
                top
            };
        };
        this.cancel = () => {
            this.showToolbox = false;
            this.domprocess.clearCanvasRect(this.interactiveCanvas);
        };
        this.download = () => {
            this.isOpenChange.emit(false);
            window.setTimeout(() => {
                const elementSelector = this.getElementSelector();
                const element = elementSelector[0];
                const options = this.getOptions(element);
                domtoimage
                    .toPng(element, options)
                    .then(this.domprocess.dataUrlToImage)
                    .then((image) => {
                    this.domprocess.remove(image);
                    return this.domprocess.clipImageToCanvas(image, this.rect.startX, this.rect.startY, this.rect.w, this.rect.h);
                })
                    .then((canvas) => this.domprocess.downloadCanvas(canvas, this.toolboxOptions.filename))
                    .then(this.domprocess.remove)
                    .catch((error) => console.error(error));
            });
        };
        this.downloadFull = () => {
            this.isOpenChange.emit(false);
            window.setTimeout(() => {
                const elementSelector = this.getElementSelector();
                const element = elementSelector[0];
                const options = this.getOptions(element);
                domtoimage
                    .toPng(element, options)
                    .then((imageUrl) => this.domprocess.downloadByUrl(imageUrl, this.toolboxOptions.filename))
                    .catch((error) => console.error(error));
            });
        };
        this.findMaxZindex = () => {
            let zMax = 0;
            $('body *').each(function () {
                const zIndexStr = $(this).css('zIndex');
                const zIndex = parseInt(zIndexStr, 10);
                if (zIndex && zIndex > zMax) {
                    zMax = zIndex;
                }
            });
            return zMax;
        };
        this.getElementSelector = () => {
            return this.target
                ? $(this.target)
                : $(this.container.nativeElement).filter((index, element) => {
                    const elementName = element.tagName.toLowerCase();
                    return elementName !== 'screenshot-toolbox';
                });
        };
        this.getOptions = (element) => {
            const boudingClientRect = element.getBoundingClientRect();
            let options = {
                width: boudingClientRect.width,
                height: boudingClientRect.height
            };
            if (this.domprocess.isTransparent(element)) {
                const parentBackgroundColor = this.domprocess.getStyle(element, 'backgroundColor');
                options = Object.assign({}, options, { bgcolor: parentBackgroundColor });
            }
            return options;
        };
        this.setHightLevelZindex = () => {
            const maxZindex = this.findMaxZindex();
            this.hightLevelZindex.second = maxZindex + 1;
            this.hightLevelZindex.top = this.hightLevelZindex.second + 1;
        };
        this.toPng = (callback) => new Promise((resolve, reject) => {
            this.isOpenChange.emit(false);
            window.setTimeout(() => {
                const elementSelector = this.getElementSelector();
                const element = elementSelector[0];
                const options = this.getOptions(element);
                return domtoimage
                    .toPng(element, options)
                    .then(this.domprocess.dataUrlToImage)
                    .then((image) => {
                    this.domprocess.remove(image);
                    return this.domprocess.clipImageToCanvas(image, this.rect.startX, this.rect.startY, this.rect.w, this.rect.h);
                })
                    .then((canvas) => {
                    const url = canvas.toDataURL('image/png');
                    if (callback) {
                        callback(url);
                    }
                    resolve(url);
                })
                    .catch((error) => {
                    console.error(error);
                    reject(error);
                });
            });
        });
        this.canvasMousedownListener = () => {
            this.showToolbox = false;
        };
        this.canvasMouseupListener = (canvas, rect) => {
            if (rect.w !== 0 && rect.h !== 0) {
                // this.showToolbox = false;
                this.rect = rect;
                const toolbox = $(this.container.nativeElement).find('ng2-screenshot-toolbox');
                console.log(toolbox.outerWidth());
                // console.log(toolbox.width())
                // // const toolbox = $('ng2-screenshot-toolbox');
                const toolboxElement = toolbox.get(0);
                console.log(toolboxElement.clientWidth);
                console.log(this.hightLevelZindex);
                /**
                 * toolbox position setting
                 * because read elememt's width sould indicated postion method, so we set position method first then move location with dom.
                 */
                this.domprocess
                    .setToolboxStackStyle(toolboxElement, this.hightLevelZindex.top.toString())
                    // .then(this.domprocess.appendToBody)
                    .then(element => {
                    const position = this.calculateToolboxPosition(canvas.offsetLeft, canvas.offsetTop, rect, element.offsetWidth, element.offsetHeight);
                    return this.domprocess.setToolboxPositionStyle(element, position.left, position.top);
                })
                    .then(element => {
                    this.showToolbox = true;
                });
            }
        };
        this.canvasContextmenuListener = () => {
            this.isOpenChange.emit(false);
        };
        this.closeScreenshot = () => {
            this.domprocess.remove(this.interactiveCanvas);
            this.showToolbox = false;
        };
        this.resizeCanvas = () => {
            if (!this.interactiveCanvas) {
                return;
            }
            const elementSelector = this.getElementSelector();
            const boudingClientRect = elementSelector[0].getBoundingClientRect();
            const width = boudingClientRect.width;
            const height = boudingClientRect.height;
            const offset = elementSelector.offset();
            const left = offset.left;
            const top = offset.top;
            this.interactiveCanvas.width = width;
            this.interactiveCanvas.height = height;
            this.domprocess
                .setCanvasStyle(this.interactiveCanvas, left, top, this.colors.gray, this.hightLevelZindex.second.toString())
                .then(() => this.showToolbox = false);
        };
    }
    ngOnInit() {
        if (!this.toolboxOptions) {
            this.toolboxOptions = {
                filename: this.defaultOptions.filename,
                cancelText: this.defaultOptions.cancelText,
                downloadText: this.defaultOptions.downloadText
            };
        }
        this.api.emit({
            cancel: this.cancel,
            download: this.download,
            downloadFull: this.downloadFull,
            toPng: this.toPng
        });
        window.onresize = () => {
            this.resizeCanvas();
        };
    }
    ngOnChanges(item) {
        const { isOpen, toolboxOptions } = item;
        switch (isOpen.currentValue) {
            case true:
                this.openScreenshot();
                break;
            case false:
                this.closeScreenshot();
                break;
            default:
                this.closeScreenshot();
                break;
        }
        if (toolboxOptions) {
            this.cancelText = toolboxOptions.cancelText ? toolboxOptions.cancelText : this.cancelText;
            this.downloadText = toolboxOptions.downloadText ? toolboxOptions.downloadText : this.downloadText;
            this.filename = toolboxOptions.filename ? toolboxOptions.filename : this.filename;
        }
    }
    openScreenshot() {
        const elementSelector = this.getElementSelector();
        const boudingClientRect = elementSelector[0].getBoundingClientRect();
        const width = boudingClientRect.width;
        const height = boudingClientRect.height;
        const offset = elementSelector.offset();
        const left = offset.left;
        const top = offset.top;
        this.setHightLevelZindex();
        this.domprocess
            .createCanvas(width, height)
            .then(canvas => this.domprocess.setCanvasStyle(canvas, left, top, this.colors.gray, this.hightLevelZindex.second.toString()))
            .then(this.domprocess.appendToBody)
            .then(canvas => this.domprocess.listenInteractiveCanvas(canvas, this.colors.lightGray, this.canvasMouseupListener, this.canvasMousedownListener, this.canvasContextmenuListener))
            .then(canvas => (this.interactiveCanvas = canvas));
    }
};
ScreenshotComponent.ctorParameters = () => [
    { type: Colors, decorators: [{ type: Inject, args: [forwardRef(() => Colors),] }] },
    { type: HightLevelZindex, decorators: [{ type: Inject, args: [forwardRef(() => HightLevelZindex),] }] },
    { type: ToolboxDefaultOptions, decorators: [{ type: Inject, args: [forwardRef(() => ToolboxDefaultOptions),] }] },
    { type: DOMProcess, decorators: [{ type: Inject, args: [forwardRef(() => DOMProcess),] }] }
];
tslib_1.__decorate([
    ViewChild('container', { static: false }),
    tslib_1.__metadata("design:type", ElementRef)
], ScreenshotComponent.prototype, "container", void 0);
tslib_1.__decorate([
    Input('target'),
    tslib_1.__metadata("design:type", String)
], ScreenshotComponent.prototype, "target", void 0);
tslib_1.__decorate([
    Input('isOpen'),
    tslib_1.__metadata("design:type", Boolean)
], ScreenshotComponent.prototype, "isOpen", void 0);
tslib_1.__decorate([
    Input('toolboxOptions'),
    tslib_1.__metadata("design:type", Object)
], ScreenshotComponent.prototype, "toolboxOptions", void 0);
tslib_1.__decorate([
    Output('isOpenChange'),
    tslib_1.__metadata("design:type", Object)
], ScreenshotComponent.prototype, "isOpenChange", void 0);
tslib_1.__decorate([
    Output('apiInitialized'),
    tslib_1.__metadata("design:type", Object)
], ScreenshotComponent.prototype, "api", void 0);
ScreenshotComponent = tslib_1.__decorate([
    Component({
        selector: 'ng2-screenshot',
        template: '<div #container><ng-content></ng-content></div>'
    }),
    tslib_1.__param(0, Inject(forwardRef(() => Colors))),
    tslib_1.__param(1, Inject(forwardRef(() => HightLevelZindex))),
    tslib_1.__param(2, Inject(forwardRef(() => ToolboxDefaultOptions))),
    tslib_1.__param(3, Inject(forwardRef(() => DOMProcess))),
    tslib_1.__metadata("design:paramtypes", [Colors,
        HightLevelZindex,
        ToolboxDefaultOptions,
        DOMProcess])
], ScreenshotComponent);
export { ScreenshotComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyZWVuc2hvdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZzItc2NyZWVuc2hvdC8iLCJzb3VyY2VzIjpbImxpYi9zY3JlZW5zaG90LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBcUIsTUFBTSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXJJLE9BQU8sRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxVQUFVLE1BQU0sY0FBYyxDQUFDO0FBQ3RDLE9BQU8sS0FBSyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzdCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNiOztHQUVHO0FBS0gsSUFBYSxtQkFBbUIsR0FBaEMsTUFBYSxtQkFBbUI7SUFjNUIsWUFDOEMsTUFBYyxFQUNKLGdCQUFrQyxFQUM3QixjQUFxQyxFQUNoRCxVQUFzQjtRQUgxQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ0oscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUM3QixtQkFBYyxHQUFkLGNBQWMsQ0FBdUI7UUFDaEQsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQWJoRCxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDaEMsUUFBRyxHQUFHLElBQUksWUFBWSxFQUFvQixDQUFDO1FBQzlELGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ25CLGVBQVUsR0FBRyxRQUFRLENBQUM7UUFDdEIsaUJBQVksR0FBRyxVQUFVLENBQUM7UUFDMUIsYUFBUSxHQUFHLGdCQUFnQixDQUFDO1FBQzVCLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBZ0RsQiw2QkFBd0Is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MUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztzQ0FBWSxVQUFVO3NEQUFDO0FBQ2hEO0lBQWhCLEtBQUssQ0FBQyxRQUFRLENBQUM7O21EQUFnQjtBQUNmO0lBQWhCLEtBQUssQ0FBQyxRQUFRLENBQUM7O21EQUFpQjtBQUNSO0lBQXhCLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQzs7MkRBQWdDO0FBQ2hDO0lBQXZCLE1BQU0sQ0FBQyxjQUFjLENBQUM7O3lEQUFtQztBQUNoQztJQUF6QixNQUFNLENBQUMsZ0JBQWdCLENBQUM7O2dEQUE0QztBQU41RCxtQkFBbUI7SUFKL0IsU0FBUyxDQUFDO1FBQ1AsUUFBUSxFQUFFLGdCQUFnQjtRQUMxQixRQUFRLEVBQUUsaURBQWlEO0tBQzlELENBQUM7SUFnQk8sbUJBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBQ2hDLG1CQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFBO0lBQzFDLG1CQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFBO0lBQy9DLG1CQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQTs2Q0FIYSxNQUFNO1FBQ2MsZ0JBQWdCO1FBQ2IscUJBQXFCO1FBQ3BDLFVBQVU7R0FsQi9ELG1CQUFtQixDQWdUL0I7U0FoVFksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgSW5qZWN0LCBmb3J3YXJkUmVmLCBPbkluaXQsIE9uQ2hhbmdlcywgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIFZpZXdDaGlsZCwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUb29sYm94T3B0aW9ucywgTmcyU2NyZWVuc2hvdEFQSSwgUmVjdCwgVG9vbGJveFBvc2l0aW9uIH0gZnJvbSAnLi9zY3JlZW5zaG90LmludGVyZmFjZSc7XHJcbmltcG9ydCB7IENvbG9ycywgSGlnaHRMZXZlbFppbmRleCwgVG9vbGJveERlZmF1bHRPcHRpb25zIH0gZnJvbSAnLi9zY3JlZW5zaG90LmNsYXNzJztcclxuaW1wb3J0IHsgRE9NUHJvY2VzcyB9IGZyb20gJy4vc2NyZWVuc2hvdC51dGlscyc7XHJcbmltcG9ydCBkb210b2ltYWdlIGZyb20gJ2RvbS10by1pbWFnZSc7XHJcbmltcG9ydCAqIGFzIGpxIGZyb20gJ2pxdWVyeSc7XHJcbmNvbnN0ICQgPSBqcTtcclxuLyoqXHJcbiAqIENhcHR1cmUgZG9tIHNldGlvbiB3aXRoIGluZGljYXRlIGVsZW1lbnRcclxuICovXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICduZzItc2NyZWVuc2hvdCcsXHJcbiAgICB0ZW1wbGF0ZTogJzxkaXYgI2NvbnRhaW5lcj48bmctY29udGVudD48L25nLWNvbnRlbnQ+PC9kaXY+J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgU2NyZWVuc2hvdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcclxuICAgIEBWaWV3Q2hpbGQoJ2NvbnRhaW5lcicsIHsgc3RhdGljOiBmYWxzZSB9KSBjb250YWluZXI6IEVsZW1lbnRSZWY7XHJcbiAgICBASW5wdXQoJ3RhcmdldCcpIHRhcmdldDogc3RyaW5nO1xyXG4gICAgQElucHV0KCdpc09wZW4nKSBpc09wZW46IGJvb2xlYW47XHJcbiAgICBASW5wdXQoJ3Rvb2xib3hPcHRpb25zJykgdG9vbGJveE9wdGlvbnM6IFRvb2xib3hPcHRpb25zO1xyXG4gICAgQE91dHB1dCgnaXNPcGVuQ2hhbmdlJykgaXNPcGVuQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gICAgQE91dHB1dCgnYXBpSW5pdGlhbGl6ZWQnKSBhcGkgPSBuZXcgRXZlbnRFbWl0dGVyPE5nMlNjcmVlbnNob3RBUEk+KCk7XHJcbiAgICBwdWJsaWMgc2hvd1Rvb2xib3ggPSBmYWxzZTtcclxuICAgIHByaXZhdGUgY2FuY2VsVGV4dCA9ICdDYW5jZWwnO1xyXG4gICAgcHJpdmF0ZSBkb3dubG9hZFRleHQgPSAnRG93bmxvYWQnO1xyXG4gICAgcHJpdmF0ZSBmaWxlbmFtZSA9ICdzY3JlZW5zaG90LnBuZyc7XHJcbiAgICBwcml2YXRlIHRvb2xib3hNYXJnaW4gPSA1O1xyXG4gICAgcHJpdmF0ZSBpbnRlcmFjdGl2ZUNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQ7XHJcbiAgICBwcml2YXRlIHJlY3Q6IFJlY3Q7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gQ29sb3JzKSkgcHJpdmF0ZSBjb2xvcnM6IENvbG9ycyxcclxuICAgICAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gSGlnaHRMZXZlbFppbmRleCkpIHByaXZhdGUgaGlnaHRMZXZlbFppbmRleDogSGlnaHRMZXZlbFppbmRleCxcclxuICAgICAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gVG9vbGJveERlZmF1bHRPcHRpb25zKSkgcHJpdmF0ZSBkZWZhdWx0T3B0aW9uczogVG9vbGJveERlZmF1bHRPcHRpb25zLFxyXG4gICAgICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBET01Qcm9jZXNzKSkgcHJpdmF0ZSBkb21wcm9jZXNzOiBET01Qcm9jZXNzLFxyXG4gICAgKSB7IH1cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIGlmICghdGhpcy50b29sYm94T3B0aW9ucykge1xyXG4gICAgICAgICAgICB0aGlzLnRvb2xib3hPcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgZmlsZW5hbWU6IHRoaXMuZGVmYXVsdE9wdGlvbnMuZmlsZW5hbWUsXHJcbiAgICAgICAgICAgICAgICBjYW5jZWxUZXh0OiB0aGlzLmRlZmF1bHRPcHRpb25zLmNhbmNlbFRleHQsXHJcbiAgICAgICAgICAgICAgICBkb3dubG9hZFRleHQ6IHRoaXMuZGVmYXVsdE9wdGlvbnMuZG93bmxvYWRUZXh0XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuYXBpLmVtaXQoe1xyXG4gICAgICAgICAgICBjYW5jZWw6IHRoaXMuY2FuY2VsLFxyXG4gICAgICAgICAgICBkb3dubG9hZDogdGhpcy5kb3dubG9hZCxcclxuICAgICAgICAgICAgZG93bmxvYWRGdWxsOiB0aGlzLmRvd25sb2FkRnVsbCxcclxuICAgICAgICAgICAgdG9Qbmc6IHRoaXMudG9QbmdcclxuICAgICAgICB9KTtcclxuICAgICAgICB3aW5kb3cub25yZXNpemUgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucmVzaXplQ2FudmFzKCk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uQ2hhbmdlcyhpdGVtOiBhbnkpIHtcclxuICAgICAgICBjb25zdCB7IGlzT3BlbiwgdG9vbGJveE9wdGlvbnMgfSA9IGl0ZW07XHJcbiAgICAgICAgc3dpdGNoIChpc09wZW4uY3VycmVudFZhbHVlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgdHJ1ZTpcclxuICAgICAgICAgICAgICAgIHRoaXMub3BlblNjcmVlbnNob3QoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGZhbHNlOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZVNjcmVlbnNob3QoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZVNjcmVlbnNob3QoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodG9vbGJveE9wdGlvbnMpIHtcclxuICAgICAgICAgICAgdGhpcy5jYW5jZWxUZXh0ID0gdG9vbGJveE9wdGlvbnMuY2FuY2VsVGV4dCA/IHRvb2xib3hPcHRpb25zLmNhbmNlbFRleHQgOiB0aGlzLmNhbmNlbFRleHQ7XHJcbiAgICAgICAgICAgIHRoaXMuZG93bmxvYWRUZXh0ID0gdG9vbGJveE9wdGlvbnMuZG93bmxvYWRUZXh0ID8gdG9vbGJveE9wdGlvbnMuZG93bmxvYWRUZXh0IDogdGhpcy5kb3dubG9hZFRleHQ7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsZW5hbWUgPSB0b29sYm94T3B0aW9ucy5maWxlbmFtZSA/IHRvb2xib3hPcHRpb25zLmZpbGVuYW1lIDogdGhpcy5maWxlbmFtZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVUb29sYm94UG9zaXRpb24gPSAoXHJcbiAgICAgICAgb2Zmc2V0TGVmdDogbnVtYmVyLFxyXG4gICAgICAgIG9mZnNldFRvcDogbnVtYmVyLFxyXG4gICAgICAgIHJlY3Q6IFJlY3QsXHJcbiAgICAgICAgdG9vbGJveFdpZHRoOiBudW1iZXIsXHJcbiAgICAgICAgdG9vbGJveEhlaWdodDogbnVtYmVyXHJcbiAgICApOiBUb29sYm94UG9zaXRpb24gPT4ge1xyXG4gICAgICAgIGxldCBsZWZ0ID0gb2Zmc2V0TGVmdCArIHJlY3Quc3RhcnRYICsgcmVjdC53O1xyXG4gICAgICAgIGxldCB0b3AgPSBvZmZzZXRUb3AgKyByZWN0LnN0YXJ0WSArIHJlY3QuaDtcclxuICAgICAgICBpZiAocmVjdC53ID49IDApIHtcclxuICAgICAgICAgICAgbGVmdCAtPSB0b29sYm94V2lkdGg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyZWN0LmggPj0gMCkge1xyXG4gICAgICAgICAgICB0b3AgKz0gdGhpcy50b29sYm94TWFyZ2luO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRvcCA9IHRvcCAtIHRvb2xib3hIZWlnaHQgLSB0aGlzLnRvb2xib3hNYXJnaW47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGxlZnQsXHJcbiAgICAgICAgICAgIHRvcFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNhbmNlbCA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLnNob3dUb29sYm94ID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5kb21wcm9jZXNzLmNsZWFyQ2FudmFzUmVjdCh0aGlzLmludGVyYWN0aXZlQ2FudmFzKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZG93bmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pc09wZW5DaGFuZ2UuZW1pdChmYWxzZSk7XHJcbiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBlbGVtZW50U2VsZWN0b3IgPSB0aGlzLmdldEVsZW1lbnRTZWxlY3RvcigpO1xyXG4gICAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudFNlbGVjdG9yWzBdO1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRPcHRpb25zKGVsZW1lbnQpO1xyXG4gICAgICAgICAgICBkb210b2ltYWdlXHJcbiAgICAgICAgICAgICAgICAudG9QbmcoZWxlbWVudCwgb3B0aW9ucylcclxuICAgICAgICAgICAgICAgIC50aGVuKHRoaXMuZG9tcHJvY2Vzcy5kYXRhVXJsVG9JbWFnZSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChpbWFnZTogSFRNTEltYWdlRWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZG9tcHJvY2Vzcy5yZW1vdmUoaW1hZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvbXByb2Nlc3MuY2xpcEltYWdlVG9DYW52YXMoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY3Quc3RhcnRYLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY3Quc3RhcnRZLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY3QudyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWN0LmhcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50KSA9PiB0aGlzLmRvbXByb2Nlc3MuZG93bmxvYWRDYW52YXMoY2FudmFzLCB0aGlzLnRvb2xib3hPcHRpb25zLmZpbGVuYW1lKSlcclxuICAgICAgICAgICAgICAgIC50aGVuKHRoaXMuZG9tcHJvY2Vzcy5yZW1vdmUpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yOiBFcnJvcikgPT4gY29uc29sZS5lcnJvcihlcnJvcikpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZG93bmxvYWRGdWxsID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuaXNPcGVuQ2hhbmdlLmVtaXQoZmFsc2UpO1xyXG4gICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZWxlbWVudFNlbGVjdG9yID0gdGhpcy5nZXRFbGVtZW50U2VsZWN0b3IoKTtcclxuICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGVsZW1lbnRTZWxlY3RvclswXTtcclxuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9ucyhlbGVtZW50KTtcclxuICAgICAgICAgICAgZG9tdG9pbWFnZVxyXG4gICAgICAgICAgICAgICAgLnRvUG5nKGVsZW1lbnQsIG9wdGlvbnMpXHJcbiAgICAgICAgICAgICAgICAudGhlbigoaW1hZ2VVcmw6IHN0cmluZykgPT4gdGhpcy5kb21wcm9jZXNzLmRvd25sb2FkQnlVcmwoaW1hZ2VVcmwsIHRoaXMudG9vbGJveE9wdGlvbnMuZmlsZW5hbWUpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogRXJyb3IpID0+IGNvbnNvbGUuZXJyb3IoZXJyb3IpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGZpbmRNYXhaaW5kZXggPSAoKTogbnVtYmVyID0+IHtcclxuICAgICAgICBsZXQgek1heCA9IDA7XHJcbiAgICAgICAgJCgnYm9keSAqJykuZWFjaChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgY29uc3QgekluZGV4U3RyOiBzdHJpbmcgPSAkKHRoaXMpLmNzcygnekluZGV4Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHpJbmRleDogbnVtYmVyID0gcGFyc2VJbnQoekluZGV4U3RyLCAxMCk7XHJcbiAgICAgICAgICAgIGlmICh6SW5kZXggJiYgekluZGV4ID4gek1heCkge1xyXG4gICAgICAgICAgICAgICAgek1heCA9IHpJbmRleDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiB6TWF4O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RWxlbWVudFNlbGVjdG9yID0gKCk6IEpRdWVyeTxIVE1MRWxlbWVudD4gPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRhcmdldFxyXG4gICAgICAgICAgICA/ICQodGhpcy50YXJnZXQpXHJcbiAgICAgICAgICAgIDogJCh0aGlzLmNvbnRhaW5lci5uYXRpdmVFbGVtZW50KS5maWx0ZXIoKGluZGV4OiBudW1iZXIsIGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlbGVtZW50TmFtZSA9IGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnROYW1lICE9PSAnc2NyZWVuc2hvdC10b29sYm94JztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRPcHRpb25zID0gKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgYm91ZGluZ0NsaWVudFJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGxldCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICB3aWR0aDogYm91ZGluZ0NsaWVudFJlY3Qud2lkdGgsXHJcbiAgICAgICAgICAgIGhlaWdodDogYm91ZGluZ0NsaWVudFJlY3QuaGVpZ2h0XHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAodGhpcy5kb21wcm9jZXNzLmlzVHJhbnNwYXJlbnQoZWxlbWVudCkpIHtcclxuICAgICAgICAgICAgY29uc3QgcGFyZW50QmFja2dyb3VuZENvbG9yID0gdGhpcy5kb21wcm9jZXNzLmdldFN0eWxlKGVsZW1lbnQsICdiYWNrZ3JvdW5kQ29sb3InKTtcclxuICAgICAgICAgICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHsgYmdjb2xvcjogcGFyZW50QmFja2dyb3VuZENvbG9yIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gb3B0aW9ucztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldEhpZ2h0TGV2ZWxaaW5kZXggPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWF4WmluZGV4ID0gdGhpcy5maW5kTWF4WmluZGV4KCk7XHJcbiAgICAgICAgdGhpcy5oaWdodExldmVsWmluZGV4LnNlY29uZCA9IG1heFppbmRleCArIDE7XHJcbiAgICAgICAgdGhpcy5oaWdodExldmVsWmluZGV4LnRvcCA9IHRoaXMuaGlnaHRMZXZlbFppbmRleC5zZWNvbmQgKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdG9QbmcgPSAoY2FsbGJhY2s6ICh1cmw6IHN0cmluZykgPT4gdm9pZCk6IFByb21pc2U8c3RyaW5nPiA9PlxyXG4gICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5pc09wZW5DaGFuZ2UuZW1pdChmYWxzZSk7XHJcbiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRTZWxlY3RvciA9IHRoaXMuZ2V0RWxlbWVudFNlbGVjdG9yKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudFNlbGVjdG9yWzBdO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9ucyhlbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkb210b2ltYWdlXHJcbiAgICAgICAgICAgICAgICAgICAgLnRvUG5nKGVsZW1lbnQsIG9wdGlvbnMpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4odGhpcy5kb21wcm9jZXNzLmRhdGFVcmxUb0ltYWdlKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChpbWFnZTogSFRNTEltYWdlRWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbXByb2Nlc3MucmVtb3ZlKGltYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tcHJvY2Vzcy5jbGlwSW1hZ2VUb0NhbnZhcyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWN0LnN0YXJ0WCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVjdC5zdGFydFksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY3QudyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVjdC5oXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAudGhlbigoY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmwgPSBjYW52YXMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh1cmwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodXJsKTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG5cclxuICAgIHB1YmxpYyBjYW52YXNNb3VzZWRvd25MaXN0ZW5lciA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLnNob3dUb29sYm94ID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNhbnZhc01vdXNldXBMaXN0ZW5lciA9IChjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LCByZWN0OiBSZWN0KSA9PiB7XHJcbiAgICAgICAgaWYgKHJlY3QudyAhPT0gMCAmJiByZWN0LmggIT09IDApIHtcclxuICAgICAgICAgICAgLy8gdGhpcy5zaG93VG9vbGJveCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLnJlY3QgPSByZWN0O1xyXG4gICAgICAgICAgICBjb25zdCB0b29sYm94ID0gJCh0aGlzLmNvbnRhaW5lci5uYXRpdmVFbGVtZW50KS5maW5kKCduZzItc2NyZWVuc2hvdC10b29sYm94Jyk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRvb2xib3gub3V0ZXJXaWR0aCgpKTtcclxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2codG9vbGJveC53aWR0aCgpKVxyXG4gICAgICAgICAgICAvLyAvLyBjb25zdCB0b29sYm94ID0gJCgnbmcyLXNjcmVlbnNob3QtdG9vbGJveCcpO1xyXG4gICAgICAgICAgICBjb25zdCB0b29sYm94RWxlbWVudCA9IHRvb2xib3guZ2V0KDApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc29sZS5sb2codG9vbGJveEVsZW1lbnQuY2xpZW50V2lkdGgpIFxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmhpZ2h0TGV2ZWxaaW5kZXgpXHJcbiAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgKiB0b29sYm94IHBvc2l0aW9uIHNldHRpbmdcclxuICAgICAgICAgICAgICogYmVjYXVzZSByZWFkIGVsZW1lbXQncyB3aWR0aCBzb3VsZCBpbmRpY2F0ZWQgcG9zdGlvbiBtZXRob2QsIHNvIHdlIHNldCBwb3NpdGlvbiBtZXRob2QgZmlyc3QgdGhlbiBtb3ZlIGxvY2F0aW9uIHdpdGggZG9tLlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgdGhpcy5kb21wcm9jZXNzXHJcbiAgICAgICAgICAgICAgICAuc2V0VG9vbGJveFN0YWNrU3R5bGUodG9vbGJveEVsZW1lbnQsIHRoaXMuaGlnaHRMZXZlbFppbmRleC50b3AudG9TdHJpbmcoKSlcclxuICAgICAgICAgICAgICAgIC8vIC50aGVuKHRoaXMuZG9tcHJvY2Vzcy5hcHBlbmRUb0JvZHkpXHJcbiAgICAgICAgICAgICAgICAudGhlbihlbGVtZW50ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMuY2FsY3VsYXRlVG9vbGJveFBvc2l0aW9uKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW52YXMub2Zmc2V0TGVmdCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FudmFzLm9mZnNldFRvcCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVjdCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5vZmZzZXRXaWR0aCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5vZmZzZXRIZWlnaHRcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvbXByb2Nlc3Muc2V0VG9vbGJveFBvc2l0aW9uU3R5bGUoZWxlbWVudCwgcG9zaXRpb24ubGVmdCwgcG9zaXRpb24udG9wKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbihlbGVtZW50ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb29sYm94ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2FudmFzQ29udGV4dG1lbnVMaXN0ZW5lciA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmlzT3BlbkNoYW5nZS5lbWl0KGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsb3NlU2NyZWVuc2hvdCA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmRvbXByb2Nlc3MucmVtb3ZlKHRoaXMuaW50ZXJhY3RpdmVDYW52YXMpO1xyXG4gICAgICAgIHRoaXMuc2hvd1Rvb2xib3ggPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9wZW5TY3JlZW5zaG90KCkge1xyXG4gICAgICAgIGNvbnN0IGVsZW1lbnRTZWxlY3RvciA9IHRoaXMuZ2V0RWxlbWVudFNlbGVjdG9yKCk7XHJcbiAgICAgICAgY29uc3QgYm91ZGluZ0NsaWVudFJlY3QgPSBlbGVtZW50U2VsZWN0b3JbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3Qgd2lkdGggPSBib3VkaW5nQ2xpZW50UmVjdC53aWR0aDtcclxuICAgICAgICBjb25zdCBoZWlnaHQgPSBib3VkaW5nQ2xpZW50UmVjdC5oZWlnaHQ7XHJcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZWxlbWVudFNlbGVjdG9yLm9mZnNldCgpO1xyXG4gICAgICAgIGNvbnN0IGxlZnQgPSBvZmZzZXQubGVmdDtcclxuICAgICAgICBjb25zdCB0b3AgPSBvZmZzZXQudG9wO1xyXG4gICAgICAgIHRoaXMuc2V0SGlnaHRMZXZlbFppbmRleCgpO1xyXG5cclxuICAgICAgICB0aGlzLmRvbXByb2Nlc3NcclxuICAgICAgICAgICAgLmNyZWF0ZUNhbnZhcyh3aWR0aCwgaGVpZ2h0KVxyXG4gICAgICAgICAgICAudGhlbihjYW52YXMgPT5cclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tcHJvY2Vzcy5zZXRDYW52YXNTdHlsZShcclxuICAgICAgICAgICAgICAgICAgICBjYW52YXMsXHJcbiAgICAgICAgICAgICAgICAgICAgbGVmdCxcclxuICAgICAgICAgICAgICAgICAgICB0b3AsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMuZ3JheSxcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZ2h0TGV2ZWxaaW5kZXguc2Vjb25kLnRvU3RyaW5nKClcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAudGhlbih0aGlzLmRvbXByb2Nlc3MuYXBwZW5kVG9Cb2R5KVxyXG4gICAgICAgICAgICAudGhlbihjYW52YXMgPT5cclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tcHJvY2Vzcy5saXN0ZW5JbnRlcmFjdGl2ZUNhbnZhcyhcclxuICAgICAgICAgICAgICAgICAgICBjYW52YXMsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMubGlnaHRHcmF5LFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2FudmFzTW91c2V1cExpc3RlbmVyLFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2FudmFzTW91c2Vkb3duTGlzdGVuZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW52YXNDb250ZXh0bWVudUxpc3RlbmVyXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLnRoZW4oY2FudmFzID0+ICh0aGlzLmludGVyYWN0aXZlQ2FudmFzID0gY2FudmFzKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXNpemVDYW52YXMgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmludGVyYWN0aXZlQ2FudmFzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZWxlbWVudFNlbGVjdG9yID0gdGhpcy5nZXRFbGVtZW50U2VsZWN0b3IoKTtcclxuICAgICAgICBjb25zdCBib3VkaW5nQ2xpZW50UmVjdCA9IGVsZW1lbnRTZWxlY3RvclswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IGJvdWRpbmdDbGllbnRSZWN0LndpZHRoO1xyXG4gICAgICAgIGNvbnN0IGhlaWdodCA9IGJvdWRpbmdDbGllbnRSZWN0LmhlaWdodDtcclxuICAgICAgICBjb25zdCBvZmZzZXQgPSBlbGVtZW50U2VsZWN0b3Iub2Zmc2V0KCk7XHJcbiAgICAgICAgY29uc3QgbGVmdCA9IG9mZnNldC5sZWZ0O1xyXG4gICAgICAgIGNvbnN0IHRvcCA9IG9mZnNldC50b3A7XHJcbiAgICAgICAgdGhpcy5pbnRlcmFjdGl2ZUNhbnZhcy53aWR0aCA9IHdpZHRoO1xyXG4gICAgICAgIHRoaXMuaW50ZXJhY3RpdmVDYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xyXG4gICAgICAgIHRoaXMuZG9tcHJvY2Vzc1xyXG4gICAgICAgICAgICAuc2V0Q2FudmFzU3R5bGUoXHJcbiAgICAgICAgICAgICAgICB0aGlzLmludGVyYWN0aXZlQ2FudmFzLFxyXG4gICAgICAgICAgICAgICAgbGVmdCxcclxuICAgICAgICAgICAgICAgIHRvcCxcclxuICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzLmdyYXksXHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZ2h0TGV2ZWxaaW5kZXguc2Vjb25kLnRvU3RyaW5nKClcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLnNob3dUb29sYm94ID0gZmFsc2UpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==